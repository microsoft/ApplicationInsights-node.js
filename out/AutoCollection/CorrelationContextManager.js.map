{"version":3,"file":"CorrelationContextManager.js","sourceRoot":"","sources":["../../AutoCollection/CorrelationContextManager.ts"],"names":[],"mappings":"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","sourcesContent":["import events = require(\"events\");\nimport Logging = require(\"../Library/Logging\");\nimport * as DiagChannel from \"./diagnostic-channel/initialization\";\nimport * as azureFunctionsTypes from \"../Library/Functions\";\n\n// Don't reference modules from these directly. Use only for types.\nimport * as cls from \"cls-hooked\";\nimport * as http from \"http\";\nimport Traceparent = require(\"../Library/Traceparent\");\nimport Tracestate = require(\"../Library/Tracestate\");\nimport HttpRequestParser = require(\"./HttpRequestParser\");\nimport { SpanContext } from \"@opentelemetry/api\";\nimport { Span } from \"@opentelemetry/sdk-trace-base\";\nimport Util = require(\"../Library/Util\");\n\nexport interface CustomProperties {\n    /**\n     * Get a custom property from the correlation context\n     */\n    getProperty(key: string): string;\n    /**\n     * Store a custom property in the correlation context.\n     * Do not store sensitive information here.\n     * Properties stored here are exposed via outgoing HTTP headers for correlating data cross-component.\n     * The characters ',' and '=' are disallowed within keys or values.\n     */\n    setProperty(key: string, value: string): void;\n}\n\nexport interface PrivateCustomProperties extends CustomProperties {\n    addHeaderData(header: string): void;\n    serializeToHeader(): string;\n}\n\nexport interface CorrelationContext {\n    operation: {\n        name: string;\n        id: string;\n        parentId: string; // Always used for dependencies, may be ignored in favor of incoming headers for requests\n        traceparent?: Traceparent; // w3c context trace\n        tracestate?: Tracestate; // w3c context state\n    };\n\n    /** Do not store sensitive information here.\n     *  Properties here are exposed via outgoing HTTP headers for correlating data cross-component.\n     */\n    customProperties: CustomProperties\n}\n\nexport class CorrelationContextManager {\n    private static enabled: boolean = false;\n    private static hasEverEnabled: boolean = false;\n    private static forceClsHooked: boolean = undefined; // true: use cls-hooked, false: use cls, undefined: choose based on node version\n    private static session: cls.Namespace;\n    private static cls: typeof cls;\n    private static CONTEXT_NAME = \"ApplicationInsights-Context\";\n\n    /**\n     *  Provides the current Context.\n     *  The context is the most recent one entered into for the current\n     *  logical chain of execution, including across asynchronous calls.\n     */\n    public static getCurrentContext(): CorrelationContext | null {\n        if (!CorrelationContextManager.enabled) {\n            return null;\n        }\n        const context = CorrelationContextManager.session.get(CorrelationContextManager.CONTEXT_NAME);\n\n        if (context === undefined) { // cast undefined to null\n            return null;\n        }\n        return context;\n    }\n\n    /**\n     *  A helper to generate objects conforming to the CorrelationContext interface\n     */\n    public static generateContextObject(operationId: string, parentId?: string, operationName?: string, correlationContextHeader?: string, traceparent?: Traceparent, tracestate?: Tracestate): CorrelationContext {\n        parentId = parentId || operationId;\n\n        if (this.enabled) {\n            return {\n                operation: {\n                    name: operationName,\n                    id: operationId,\n                    parentId: parentId,\n                    traceparent,\n                    tracestate\n                },\n                customProperties: new CustomPropertiesImpl(correlationContextHeader)\n            };\n        }\n\n        return null;\n    }\n\n    public static spanToContextObject(spanContext: SpanContext, parentId?: string, name?: string): CorrelationContext {\n        const traceContext = new Traceparent();\n        traceContext.traceId = spanContext.traceId;\n        traceContext.spanId = spanContext.spanId;\n        traceContext.traceFlag = Traceparent.formatOpenTelemetryTraceFlags(spanContext.traceFlags) || Traceparent.DEFAULT_TRACE_FLAG;\n        traceContext.parentId = parentId;\n        return CorrelationContextManager.generateContextObject(traceContext.traceId, traceContext.parentId, name, null, traceContext);\n    }\n\n    /**\n     *  Runs a function inside a given Context.\n     *  All logical children of the execution path that entered this Context\n     *  will receive this Context object on calls to GetCurrentContext.\n     */\n    public static runWithContext(context: CorrelationContext, fn: () => any): any {\n        if (CorrelationContextManager.enabled) {\n            try {\n                return CorrelationContextManager.session.bind(fn, { [CorrelationContextManager.CONTEXT_NAME]: context })();\n            }\n            catch (error) {\n                Logging.warn(\"Error binding to session context\", Util.dumpObj(error));\n            }\n        }\n        return fn();\n    }\n\n    /**\n     * Wrapper for cls-hooked bindEmitter method\n     */\n    public static wrapEmitter(emitter: events.EventEmitter): void {\n        if (CorrelationContextManager.enabled) {\n            try {\n                CorrelationContextManager.session.bindEmitter(emitter);\n            }\n            catch (error) {\n                Logging.warn(\"Error binding to session context\", Util.dumpObj(error));\n            }\n        }\n    }\n\n    /**\n     *  Patches a callback to restore the correct Context when getCurrentContext\n     *  is run within it. This is necessary if automatic correlation fails to work\n     *  with user-included libraries.\n     *\n     *  The supplied callback will be given the same context that was present for\n     *  the call to wrapCallback.  */\n    public static wrapCallback<T extends Function>(fn: T, context?: CorrelationContext): T {\n        if (CorrelationContextManager.enabled) {\n            try {\n                return CorrelationContextManager.session.bind(fn, context ? {\n                    [CorrelationContextManager.CONTEXT_NAME]: context\n                } : undefined);\n            }\n            catch (error) {\n                Logging.warn(\"Error binding to session context\", Util.dumpObj(error));\n            }\n        }\n        return fn;\n    }\n\n    /**\n     *  Enables the CorrelationContextManager.\n     */\n    public static enable(forceClsHooked?: boolean) {\n        if (this.enabled) {\n            return;\n        }\n\n        if (!this.isNodeVersionCompatible()) {\n            this.enabled = false;\n            return;\n        }\n        if (!CorrelationContextManager.hasEverEnabled) {\n            this.forceClsHooked = forceClsHooked;\n            this.hasEverEnabled = true;\n\n            if (typeof this.cls === \"undefined\") {\n                if ((CorrelationContextManager.forceClsHooked === true) || (CorrelationContextManager.forceClsHooked === undefined && CorrelationContextManager.shouldUseClsHooked())) {\n                    this.cls = require(\"cls-hooked\");\n                } else {\n                    this.cls = require(\"continuation-local-storage\");\n                }\n            }\n\n            CorrelationContextManager.session = this.cls.createNamespace(\"AI-CLS-Session\");\n\n            DiagChannel.registerContextPreservation((cb) => {\n                try {\n                    return CorrelationContextManager.session.bind(cb);\n                }\n                catch (error) {\n                    Logging.warn(\"Error binding to session context\", Util.dumpObj(error));\n                }\n            });\n        }\n\n        this.enabled = true;\n    }\n\n    /**\n     * Create new correlation context.\n     */\n    public static startOperation(\n        input: azureFunctionsTypes.Context | (http.IncomingMessage | azureFunctionsTypes.HttpRequest) | SpanContext | Span,\n        request?: azureFunctionsTypes.HttpRequest | string)\n        : CorrelationContext | null {\n        const traceContext = input && (input as azureFunctionsTypes.Context).traceContext || null;\n        const span = input && (input as Span).spanContext ? input as Span : null;\n        const spanContext = input && (input as SpanContext).traceId ? input as SpanContext : null;\n        const headers = input && (input as http.IncomingMessage | azureFunctionsTypes.HttpRequest).headers;\n\n        // OpenTelemetry Span\n        if (span) {\n            return this.spanToContextObject(span.spanContext(), span.parentSpanId, span.name);\n        }\n\n        // OpenTelemetry SpanContext\n        if (spanContext) {\n            return this.spanToContextObject(spanContext, `|${spanContext.traceId}.${spanContext.spanId}.`, typeof request === \"string\" ? request : \"\");\n        }\n\n        let operationName = typeof request === \"string\" ? request : \"\";\n\n        // AzFunction TraceContext\n        if (traceContext) {\n            let traceparent = null;\n            let tracestate = null;\n            operationName = traceContext.attributes[\"OperationName\"] || operationName;\n            if (request) {\n                let azureFnRequest = request as azureFunctionsTypes.HttpRequest;\n                if (azureFnRequest.headers) {\n                    if (azureFnRequest.headers.traceparent) {\n                        traceparent = new Traceparent(azureFnRequest.headers.traceparent);\n                    } else if (azureFnRequest.headers[\"request-id\"]) {\n                        traceparent = new Traceparent(null, azureFnRequest.headers[\"request-id\"]);\n                    }\n                    if (azureFnRequest.headers.tracestate) {\n                        tracestate = new Tracestate(azureFnRequest.headers.tracestate);\n                    }\n                }\n            }\n            if (!traceparent) {\n                traceparent = new Traceparent(traceContext.traceparent);\n            }\n            if (!tracestate) {\n                tracestate = new Tracestate(traceContext.tracestate);\n            }\n\n            let correlationContextHeader = undefined;\n            if (typeof request === \"object\") {\n                const parser = new HttpRequestParser(request);\n                correlationContextHeader = parser.getCorrelationContextHeader();\n                operationName = parser.getOperationName({});\n            }\n            const correlationContext = CorrelationContextManager.generateContextObject(\n                traceparent.traceId,\n                traceparent.parentId,\n                operationName,\n                correlationContextHeader,\n                traceparent,\n                tracestate\n            );\n\n            return correlationContext;\n        }\n\n        // No TraceContext available, parse as http.IncomingMessage\n        if (headers) {\n            const traceparent = new Traceparent(headers.traceparent ? headers.traceparent.toString() : null);\n            const tracestate = new Tracestate(headers.tracestate ? headers.tracestate.toString() : null);\n            const parser = new HttpRequestParser(input as http.IncomingMessage | azureFunctionsTypes.HttpRequest);\n            const correlationContext = CorrelationContextManager.generateContextObject(\n                traceparent.traceId,\n                traceparent.parentId,\n                parser.getOperationName({}),\n                parser.getCorrelationContextHeader(),\n                traceparent,\n                tracestate\n            );\n\n            return correlationContext;\n        }\n\n        Logging.warn(\"startOperation was called with invalid arguments\", arguments);\n        return null;\n    }\n\n    /**\n     *  Disables the CorrelationContextManager.\n     */\n    public static disable() {\n        this.enabled = false;\n    }\n\n    /**\n     * Reset the namespace\n     */\n    public static reset() {\n        if (CorrelationContextManager.hasEverEnabled) {\n            CorrelationContextManager.session = null;\n            CorrelationContextManager.session = this.cls.createNamespace(\"AI-CLS-Session\");\n        }\n    }\n\n    /**\n     *  Reports if CorrelationContextManager is able to run in this environment\n     */\n    public static isNodeVersionCompatible() {\n        var nodeVer = process.versions.node.split(\".\");\n        return parseInt(nodeVer[0]) > 3 || (parseInt(nodeVer[0]) > 2 && parseInt(nodeVer[1]) > 2);\n\n    }\n\n    /**\n     * We only want to use cls-hooked when it uses async_hooks api (8.2+), else\n     * use async-listener (plain -cls)\n     */\n    public static shouldUseClsHooked() {\n        var nodeVer = process.versions.node.split(\".\");\n        return (parseInt(nodeVer[0]) > 8) || (parseInt(nodeVer[0]) >= 8 && parseInt(nodeVer[1]) >= 2);\n    }\n\n    /**\n     * A TypeError is triggered by cls-hooked for node [8.0, 8.2)\n     * @internal Used in tests only\n     */\n    public static canUseClsHooked() {\n        var nodeVer = process.versions.node.split(\".\");\n        var greater800 = (parseInt(nodeVer[0]) > 8) || (parseInt(nodeVer[0]) >= 8 && parseInt(nodeVer[1]) >= 0);\n        var less820 = (parseInt(nodeVer[0]) < 8) || (parseInt(nodeVer[0]) <= 8 && parseInt(nodeVer[1]) < 2)\n        var greater470 = parseInt(nodeVer[0]) > 4 || (parseInt(nodeVer[0]) >= 4 && parseInt(nodeVer[1]) >= 7) // cls-hooked requires node 4.7+\n        return !(greater800 && less820) && greater470;\n    }\n}\n\nclass CustomPropertiesImpl implements PrivateCustomProperties {\n    private static bannedCharacters = /[,=]/;\n    private props: { key: string, value: string }[] = [];\n\n    public constructor(header: string) {\n        this.addHeaderData(header);\n    }\n\n    public addHeaderData(header?: string) {\n        const keyvals = header ? header.split(\", \") : [];\n        this.props = keyvals.map((keyval) => {\n            const parts = keyval.split(\"=\");\n            return { key: parts[0], value: parts[1] };\n        }).concat(this.props);\n    }\n\n    public serializeToHeader() {\n        return this.props.map((keyval) => {\n            return `${keyval.key}=${keyval.value}`\n        }).join(\", \");\n    }\n\n    public getProperty(prop: string) {\n        for (let i = 0; i < this.props.length; ++i) {\n            const keyval = this.props[i]\n            if (keyval.key === prop) {\n                return keyval.value;\n            }\n        }\n        return;\n    }\n\n    // TODO: Strictly according to the spec, properties which are recieved from\n    // an incoming request should be left untouched, while we may add our own new\n    // properties. The logic here will need to change to track that.\n    public setProperty(prop: string, val: string) {\n        if (CustomPropertiesImpl.bannedCharacters.test(prop) || CustomPropertiesImpl.bannedCharacters.test(val)) {\n            Logging.warn(\"Correlation context property keys and values must not contain ',' or '='. setProperty was called with key: \" + prop + \" and value: \" + val);\n            return;\n        }\n        for (let i = 0; i < this.props.length; ++i) {\n            const keyval = this.props[i];\n            if (keyval.key === prop) {\n                keyval.value = val;\n                return;\n            }\n        }\n        this.props.push({ key: prop, value: val });\n    }\n}"]}