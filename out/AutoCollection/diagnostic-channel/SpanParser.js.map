{"version":3,"file":"SpanParser.js","sourceRoot":"","sources":["../../../AutoCollection/diagnostic-channel/SpanParser.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license. See LICENSE file in the project root for details.\nimport { URL } from \"url\";\nimport { SpanKind, SpanStatusCode, Link } from \"@opentelemetry/api\";\nimport { SemanticAttributes, DbSystemValues } from \"@opentelemetry/semantic-conventions\";\nimport { ReadableSpan } from \"@opentelemetry/sdk-trace-base\";\n\nimport * as Contracts from \"../../Declarations/Contracts\";\nimport * as Constants from \"../../Declarations/Constants\";\nimport { parseEventHubSpan } from \"./Azure/EventHub\";\nimport { DependencyTelemetry } from \"../../Declarations/Contracts\";\nimport Util = require(\"../../Library/Util\");\n\nfunction createPropertiesFromSpan(span: ReadableSpan): { [key: string]: any; } {\n    const properties: { [key: string]: any; } = {};\n    for (const key of Object.keys(span.attributes)) {\n        if (\n            !(\n                key.startsWith(\"http.\") ||\n                key.startsWith(\"rpc.\") ||\n                key.startsWith(\"db.\") ||\n                key.startsWith(\"peer.\") ||\n                key.startsWith(\"net.\")\n            )\n        ) {\n            properties[key] = span.attributes[key] as string;\n        }\n    }\n    const links: Array<{ operation_Id: string, id: string }> = span.links.map((link: Link) => ({\n        operation_Id: link.context.traceId,\n        id: link.context.spanId\n    }));\n    if (links.length > 0) {\n        properties[\"_MS.links\"] = Util.stringify(links);\n    }\n    return properties;\n}\n\nfunction isSqlDB(dbSystem: string) {\n    return (\n        dbSystem === DbSystemValues.DB2 ||\n        dbSystem === DbSystemValues.DERBY ||\n        dbSystem === DbSystemValues.MARIADB ||\n        dbSystem === DbSystemValues.MSSQL ||\n        dbSystem === DbSystemValues.ORACLE ||\n        dbSystem === DbSystemValues.SQLITE ||\n        dbSystem === DbSystemValues.OTHER_SQL ||\n        dbSystem === DbSystemValues.HSQLDB ||\n        dbSystem === DbSystemValues.H2\n    );\n}\n\nfunction getUrl(span: ReadableSpan): string {\n    const httpMethod = span.attributes[SemanticAttributes.HTTP_METHOD];\n    if (httpMethod) {\n        const httpUrl = span.attributes[SemanticAttributes.HTTP_URL];\n        if (httpUrl) {\n            return String(httpUrl);\n        } else {\n            const httpScheme = span.attributes[SemanticAttributes.HTTP_SCHEME];\n            const httpTarget = span.attributes[SemanticAttributes.HTTP_TARGET];\n            if (httpScheme && httpTarget) {\n                const httpHost = span.attributes[SemanticAttributes.HTTP_HOST];\n                if (httpHost) {\n                    return `${httpScheme}://${httpHost}${httpTarget}`;\n                } else {\n                    const netPeerPort = span.attributes[SemanticAttributes.NET_PEER_PORT];\n                    if (netPeerPort) {\n                        const netPeerName = span.attributes[SemanticAttributes.NET_PEER_NAME];\n                        if (netPeerName) {\n                            return `${httpScheme}://${netPeerName}:${netPeerPort}${httpTarget}`;\n                        } else {\n                            const netPeerIp = span.attributes[SemanticAttributes.NET_PEER_IP];\n                            if (netPeerIp) {\n                                return `${httpScheme}://${netPeerIp}:${netPeerPort}${httpTarget}`;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n    return \"\";\n}\n\nfunction getDependencyTarget(span: ReadableSpan): string {\n    const peerService = span.attributes[SemanticAttributes.PEER_SERVICE];\n    const httpHost = span.attributes[SemanticAttributes.HTTP_HOST];\n    const httpUrl = span.attributes[SemanticAttributes.HTTP_URL];\n    const netPeerName = span.attributes[SemanticAttributes.NET_PEER_NAME];\n    const netPeerIp = span.attributes[SemanticAttributes.NET_PEER_IP];\n    if (peerService) {\n        return String(peerService);\n    } else if (httpHost) {\n        return String(httpHost);\n    } else if (httpUrl) {\n        return String(httpUrl);\n    } else if (netPeerName) {\n        return String(netPeerName);\n    } else if (netPeerIp) {\n        return String(netPeerIp);\n    }\n    return \"\";\n}\n\nfunction createDependencyData(span: ReadableSpan): Contracts.DependencyTelemetry {\n    const remoteDependency: Contracts.DependencyTelemetry = {\n        name: span.name,\n        success: span.status.code != SpanStatusCode.ERROR,\n        resultCode: \"0\",\n        duration: 0,\n        data: \"\",\n        dependencyTypeName: \"\"\n    };\n    if (span.kind === SpanKind.PRODUCER) {\n        remoteDependency.dependencyTypeName = Constants.DependencyTypeName.QueueMessage;\n    }\n    if (span.kind === SpanKind.INTERNAL && span.parentSpanId) {\n        remoteDependency.dependencyTypeName = Constants.DependencyTypeName.InProc;\n    }\n\n    const httpMethod = span.attributes[SemanticAttributes.HTTP_METHOD];\n    const dbSystem = span.attributes[SemanticAttributes.DB_SYSTEM];\n    const rpcSystem = span.attributes[SemanticAttributes.RPC_SYSTEM];\n    // HTTP Dependency\n    if (httpMethod) {\n        remoteDependency.dependencyTypeName = Constants.DependencyTypeName.Http;\n        const httpUrl = span.attributes[SemanticAttributes.HTTP_URL];\n        if (httpUrl) {\n            var pathName = \"\";\n            try {\n                let dependencyUrl = new URL(String(httpUrl));\n                pathName = dependencyUrl.pathname;\n            }\n            catch (ex) {\n                // Ignore error\n            }\n            remoteDependency.name = `${httpMethod} ${pathName}`;\n        }\n        remoteDependency.data = getUrl(span);\n        const httpStatusCode = span.attributes[SemanticAttributes.HTTP_STATUS_CODE];\n        if (httpStatusCode) {\n            remoteDependency.resultCode = String(httpStatusCode);\n        }\n        let target = getDependencyTarget(span);\n        if (target) {\n            try {\n                // Remove default port\n                let portRegex = new RegExp(/(https?)(:\\/\\/.*)(:\\d+)(\\S*)/);\n                let res = portRegex.exec(target);\n                if (res != null) {\n                    let protocol = res[1];\n                    let port = res[3];\n                    if ((protocol == \"https\" && port == \":443\") || (protocol == \"http\" && port == \":80\")) {\n                        // Drop port\n                        target = res[1] + res[2] + res[4];\n                    }\n                }\n            } catch (error) {\n                // Ignore error\n            }\n            remoteDependency.target = `${target}`;\n        }\n    }\n    // DB Dependency\n    else if (dbSystem) {\n        // TODO: Remove special logic when Azure UX supports OpenTelemetry dbSystem\n        if (String(dbSystem) === DbSystemValues.MYSQL) {\n            remoteDependency.dependencyTypeName = \"mysql\";\n        } else if (String(dbSystem) === DbSystemValues.POSTGRESQL) {\n            remoteDependency.dependencyTypeName = \"postgresql\";\n        } else if (String(dbSystem) === DbSystemValues.MONGODB) {\n            remoteDependency.dependencyTypeName = \"mongodb\";\n        } else if (String(dbSystem) === DbSystemValues.REDIS) {\n            remoteDependency.dependencyTypeName = \"redis\";\n        } else if (isSqlDB(String(dbSystem))) {\n            remoteDependency.dependencyTypeName = \"SQL\";\n        } else {\n            remoteDependency.dependencyTypeName = String(dbSystem);\n        }\n        const dbStatement = span.attributes[SemanticAttributes.DB_STATEMENT];\n        const dbOperation = span.attributes[SemanticAttributes.DB_OPERATION];\n        if (dbStatement) {\n            remoteDependency.data = String(dbStatement);\n        }\n        else if (dbOperation) {\n            remoteDependency.data = String(dbOperation);\n        }\n        let target = getDependencyTarget(span);\n        const dbName = span.attributes[SemanticAttributes.DB_NAME];\n        if (target) {\n            remoteDependency.target = dbName ? `${target}|${dbName}` : `${target}`;\n        } else {\n            remoteDependency.target = dbName ? `${dbName}` : `${dbSystem}`;\n        }\n    }\n    // grpc Dependency\n    else if (rpcSystem) {\n        remoteDependency.dependencyTypeName = Constants.DependencyTypeName.Grpc;\n        const grpcStatusCode = span.attributes[SemanticAttributes.RPC_GRPC_STATUS_CODE];\n        if (grpcStatusCode) {\n            remoteDependency.resultCode = String(grpcStatusCode);\n        }\n        let target = getDependencyTarget(span);\n        if (target) {\n            remoteDependency.target = `${target}`;\n        } else if (rpcSystem) {\n            remoteDependency.target = String(rpcSystem);\n        }\n    }\n    return remoteDependency;\n}\n\nfunction createRequestData(span: ReadableSpan): Contracts.RequestTelemetry {\n    const requestData: Contracts.RequestTelemetry = {\n        name: span.name,\n        success: span.status.code != SpanStatusCode.ERROR,\n        resultCode: \"0\",\n        duration: 0,\n        url: \"\",\n        source: undefined\n    };\n    const httpMethod = span.attributes[SemanticAttributes.HTTP_METHOD];\n    const grpcStatusCode = span.attributes[SemanticAttributes.RPC_GRPC_STATUS_CODE];\n    if (httpMethod) {\n        // Try to get request name for server spans\n        if (span.kind == SpanKind.SERVER) {\n            const httpRoute = span.attributes[SemanticAttributes.HTTP_ROUTE];\n            const httpUrl = span.attributes[SemanticAttributes.HTTP_URL];\n            if (httpRoute) {\n                requestData.name = `${httpMethod as string} ${httpRoute as string}`;\n            }\n            else if (httpUrl) {\n                try {\n                    let url = new URL(String(httpUrl));\n                    requestData.name = `${httpMethod} ${url.pathname}`;\n                }\n                catch (ex) {\n                    // Ignore error\n                }\n            }\n        }\n        requestData.url = getUrl(span);\n        const httpStatusCode = span.attributes[SemanticAttributes.HTTP_STATUS_CODE];\n        if (httpStatusCode) {\n            requestData.resultCode = String(httpStatusCode);\n        }\n    } else if (grpcStatusCode) {\n        requestData.resultCode = String(grpcStatusCode);\n    }\n    return requestData;\n}\n\nexport function spanToTelemetryContract(span: ReadableSpan): (Contracts.DependencyTelemetry | Contracts.RequestTelemetry) & Contracts.Identified {\n    let telemetry: (Contracts.DependencyTelemetry | Contracts.RequestTelemetry) & Contracts.Identified;\n    switch (span.kind) {\n        case SpanKind.CLIENT:\n        case SpanKind.PRODUCER:\n        case SpanKind.INTERNAL:\n            telemetry = createDependencyData(span);\n            break;\n        case SpanKind.SERVER:\n        case SpanKind.CONSUMER:\n            telemetry = createRequestData(span);\n            break;\n    }\n\n    const spanContext = span.spanContext ? span.spanContext() : (<any>span).context(); // context is available in OT API <v0.19.0\n    const id = `${spanContext.spanId}`;\n    const duration = Math.round(span.duration[0] * 1e3 + span.duration[1] / 1e6);\n    telemetry.id = id;\n    telemetry.duration = duration;\n    telemetry.properties = createPropertiesFromSpan(span);\n\n    // Azure SDK\n    if (span.attributes[Constants.AzNamespace]) {\n        if (span.kind === SpanKind.INTERNAL) {\n            (<DependencyTelemetry>telemetry).dependencyTypeName = `${Constants.DependencyTypeName.InProc} | ${span.attributes[Constants.AzNamespace]}`\n        }\n        if (span.attributes[Constants.AzNamespace] === Constants.MicrosoftEventHub) {\n            parseEventHubSpan(span, telemetry);\n        }\n    }\n    return telemetry;\n}\n"]}